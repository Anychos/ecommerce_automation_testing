name: Ecommerce Shop Test Automation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  # 2️⃣ API тесты
  api-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Создание .env файла
        run: |
          cat <<EOF > .env
          # API
          HTTP_CLIENT.BASE_URL=http://localhost:8080
          HTTP_CLIENT.TIMEOUT=10
          SWAGGER_COVERAGE_SERVICES=[{"key":"online_shop_test_api","name":"Online Shop Test API","repository":"https://github.com/Anychos/practice_api_test_server.git","swagger_url":"http://localhost:8080/openapi.json"}]
          ADMIN_DATA.EMAIL=test_admin@mail.ru
          ADMIN_DATA.PASSWORD=test_admin_password

          # UI
          BASE_URL=http://127.0.0.1:5000
          HEADLESS=true
          BROWSER=["chromium"]
          BROWSER_VIEWPORT={"width":1280,"height":720,"device_scale_factor":1}
          TEST_USER.EMAIL=test_user_1@example.com
          TEST_USER.NAME='Test User'
          TEST_USER.PHONE=71234567890
          TEST_USER.PASSWORD=test_password_123
          TEST_USER.CONFIRM_PASSWORD=test_password_123
          SESSION_BROWSER_STATE_FILE=session-browser-state.json
          FUNCTION_BROWSER_STATE_FILE=function-browser-state.json
          ALLURE_RESULTS_DIR=./allure-results
          EOF

      - name: Установка зависимостей проекта
        run: pip install -r requirements.txt

      - name: Клонирование API сервера
        run: git clone https://github.com/Anychos/practice_api_test_server.git

      - name: Установка зависимостей API сервера
        run: |
          cd practice_api_test_server
          pip install -r requirements.txt

      - name: Применение миграций
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          ADMIN_EMAIL: test_admin@mail.ru
          ADMIN_PASSWORD: test_admin_password
          ADMIN_NAME: Admin
          ADMIN_PHONE: +71234567890
        run: |
          cd practice_api_test_server
          alembic upgrade head

      - name: Запуск API сервера
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          SECRET_KEY: test-secret
        run: |
          cd practice_api_test_server
          python app.py &

      - name: Ожидание запуска API сервера
        run: |
          for i in {1..30}; do
            curl -s http://localhost:8080/health && exit 0
            sleep 2
          done
          exit 1

      - name: Запуск тестов API
        run: |
          pytest tests/api \
                 --alluredir=allure-results-api \
                 -n 4 \
                 --reruns 2 \
                 --reruns-delay 2

      - name: Upload API Allure results
        uses: actions/upload-artifact@v4
        with:
          name: allure-api
          path: allure-results-api

  # 3️⃣ UI тесты
  ui-tests:
    runs-on: ubuntu-latest
    needs: api-tests
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Создание .env файла
        run: |
          cat <<EOF > .env
          # API
          HTTP_CLIENT.BASE_URL=http://localhost:8080
          HTTP_CLIENT.TIMEOUT=10
          SWAGGER_COVERAGE_SERVICES=[{"key":"online_shop_test_api","name":"Online Shop Test API","repository":"https://github.com/Anychos/practice_api_test_server.git","swagger_url":"http://localhost:8080/openapi.json"}]
          ADMIN_DATA.EMAIL=test_admin@mail.ru
          ADMIN_DATA.PASSWORD=test_admin_password

          # UI
          BASE_URL=http://127.0.0.1:5000
          HEADLESS=true
          BROWSER=["chromium"]
          BROWSER_VIEWPORT={"width":1280,"height":720,"device_scale_factor":1}
          TEST_USER.EMAIL=test_user_1@example.com
          TEST_USER.NAME='Test User'
          TEST_USER.PHONE=71234567890
          TEST_USER.PASSWORD=test_password_123
          TEST_USER.CONFIRM_PASSWORD=test_password_123
          SESSION_BROWSER_STATE_FILE=session-browser-state.json
          FUNCTION_BROWSER_STATE_FILE=function-browser-state.json
          ALLURE_RESULTS_DIR=./allure-results
          EOF

      - name: Установка зависимостей проекта
        run: pip install -r requirements.txt

      - name: Клонирование API сервера
        run: git clone https://github.com/Anychos/practice_api_test_server.git

      - name: Установка зависимостей API сервера
        run: |
          cd practice_api_test_server
          pip install -r requirements.txt

      - name: Применение миграций
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          ADMIN_EMAIL: test_admin@mail.ru
          ADMIN_PASSWORD: test_admin_password
          ADMIN_NAME: Admin
          ADMIN_PHONE: +71234567890
        run: |
          cd practice_api_test_server
          alembic upgrade head

      - name: Запуск API сервера
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          SECRET_KEY: secret-key
        run: |
          cd practice_api_test_server
          python app.py &

      - name: Ожидание запуска API сервера
        run: |
          for i in {1..30}; do
            curl -s http://localhost:8080/health && exit 0
            sleep 2
          done
          exit 1

      - name: Установка Python и Playwright зависимостей
        run: |
          pip install -r requirements.txt
          playwright install --with-deps

      - name: Клонирование UI сервера
        run: git clone https://github.com/Anychos/practice_ui_test_server.git

      - name: Установка зависимостей UI сервера
        run: |
          cd practice_ui_test_server
          pip install -r requirements.txt

      - name: Запуск UI сервера
        env:
          API_BASE_URL: http://localhost:8080
          SECRET_KEY: secret-key
        run: |
          cd practice_ui_test_server
          python app.py &

      - name: Ожидание запуска UI сервера
        run: |
          for i in {1..30}; do
            curl -s http://127.0.0.1:5000 && exit 0
            sleep 2
          done
          exit 1

      - name: Запуск UI тестов
        run: |
          pytest tests/ui \
                 --alluredir=allure-results-ui \
                 -n 3 \
                 --reruns 3 \
                 --reruns-delay 4

      - name: Upload UI Allure results
        uses: actions/upload-artifact@v4
        with:
          name: allure-ui
          path: allure-results-ui

  # 4️⃣ Allure report
  allure-report:
    runs-on: ubuntu-latest
    needs: [api-tests, ui-tests]
    if: always()

    steps:
      - uses: actions/checkout@v6

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Скачивание результатов API тестов
        uses: actions/download-artifact@v4
        with:
          name: allure-api
          path: api-results

      - name: Скачивание результатов UI тестов
        uses: actions/download-artifact@v4
        with:
          name: allure-ui
          path: ui-results

      - name: Объединение результатов в одной директории
        run: |
          mkdir -p allure-results
          cp -r api-results/* allure-results/ || true
          cp -r ui-results/* allure-results/ || true

      - name: Копирование истории предыдущих запусков
        run: |
          if [ -d "gh-pages/latest/history" ]; then
            mkdir -p allure-results/history
            cp -r gh-pages/latest/history/* allure-results/history/
          fi

      - name: Генерация Allure отчета
        uses: simple-elf/allure-report-action@v1.13
        with:
          allure_results: allure-results
          allure_history: allure-history
          keep_reports: 5

      - name: Публикация Allure отчета
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-history
          publish_branch: gh-pages
          keep_files: false

  notify:
    runs-on: ubuntu-latest
    needs: [ allure-report ]
    if: always()

    steps:
      - name: Уведомление о статусе CI
        run: |
          STATUS="${{ needs.allure-report.result }}"
          
          ALLURE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.run_number }}/index.html"

          if [ "$STATUS" = "success" ]; then
            ICON="✅"
          else
            ICON="❌"
          fi

          MESSAGE=$(cat <<EOF
          $ICON CI: $STATUS
          
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          
          Allure Report: $ALLURE_URL
          Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF
          )
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="$MESSAGE"
          
          
          
