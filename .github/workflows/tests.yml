name: Ecommerce Shop Test Automation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
  API_URL: http://localhost:8080
  UI_URL: http://localhost:5000

jobs:

# API TESTS

  api-tests:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test_user -d test_db"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Clone API server
        run: git clone https://github.com/Anychos/practice_api_test_server.git

      - name: Install API dependencies
        run: |
          cd practice_api_test_server
          pip install -r requirements.txt

      - name: Run migrations
        run: |
          cd practice_api_test_server
          alembic upgrade head

      - name: Start API server
        run: |
          cd practice_api_test_server
          nohup python app.py > api.log 2>&1 &

      - name: Wait for API
        run: |
          for i in {1..30}; do
            curl -s $API_URL/health && exit 0
            sleep 2
          done
          echo "API failed"
          cat practice_api_test_server/api.log
          exit 1

      - name: Run API tests
        run: |
          pytest tests/api \
                 --alluredir=allure-results-api \
                 -n auto \
                 --reruns 2

      - name: Upload API Allure results
        uses: actions/upload-artifact@v4
        with:
          name: allure-api
          path: allure-results-api

# UI TESTS

  ui-tests:
    runs-on: ubuntu-latest
    needs: api-tests   # если хочешь последовательность
                       # убери needs если хочешь параллель

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test_user -d test_db"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install system deps
        run: sudo apt-get update && sudo apt-get install -y curl

      - name: Install test dependencies
        run: |
          pip install -r requirements.txt
          playwright install --with-deps

      # --- API ---
      - name: Clone API
        run: git clone https://github.com/Anychos/practice_api_test_server.git

      - name: Install & run API
        run: |
          cd practice_api_test_server
          pip install -r requirements.txt
          alembic upgrade head
          nohup python app.py > api.log 2>&1 &

      - name: Wait API
        run: |
          for i in {1..30}; do
            curl -s $API_URL/health && exit 0
            sleep 2
          done
          exit 1

      # --- UI ---
      - name: Clone UI
        run: git clone https://github.com/Anychos/practice_ui_test_server.git

      - name: Install & run UI
        env:
          API_BASE_URL: http://localhost:8080
          SECRET_KEY: test-secret
        run: |
          cd practice_ui_test_server
          pip install -r requirements.txt
          nohup python app.py > ui.log 2>&1 &

      - name: Wait UI
        run: |
          for i in {1..30}; do
            curl -s $UI_URL && exit 0
            sleep 2
          done
          exit 1

      - name: Run UI tests
        run: |
          pytest tests/ui \
                 --alluredir=allure-results-ui \
                 -n auto \
                 --reruns 2

      - name: Upload UI Allure results
        uses: actions/upload-artifact@v4
        with:
          name: allure-ui
          path: allure-results-ui

# ALLURE REPORT

  allure-report:
    runs-on: ubuntu-latest
    needs: [api-tests, ui-tests]

    steps:
      - uses: actions/checkout@v4

      - name: Download API results
        uses: actions/download-artifact@v4
        with:
          name: allure-api
          path: allure-results

      - name: Download UI results
        uses: actions/download-artifact@v4
        with:
          name: allure-ui
          path: allure-results

      - name: Generate Allure report
        uses: simple-elf/allure-report-action@v1.7
        with:
          allure_results: allure-results
          allure_history: allure-history

      - name: Publish Allure report
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-history
          publish_branch: gh-pages


