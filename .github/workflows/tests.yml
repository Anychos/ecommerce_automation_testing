name: Ecommerce Shop Test Automation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  # 2️⃣ API тесты
  api-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test_user -d test_db"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Clone API server
        run: git clone https://github.com/Anychos/practice_api_test_server.git

      - name: Install API dependencies
        run: |
          cd practice_api_test_server
          pip install -r requirements.txt

      - name: Run migrations
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          ADMIN_EMAIL: test_admin@mail.ru
          ADMIN_PASSWORD: test_admin_password
          ADMIN_NAME: Admin
          ADMIN_PHONE: +71234567890
        run: |
          cd practice_api_test_server
          until pg_isready -h localhost -p 5432 -U test_user; do sleep 2; done
          alembic upgrade head

      - name: Start API server
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          SECRET_KEY: test-secret
        run: |
          cd practice_api_test_server
          nohup python app.py > api.log 2>&1 &

      - name: Wait for API
        run: |
          for i in {1..30}; do
            curl -s http://localhost:8080/health && exit 0
            sleep 2
          done
          exit 1

      - name: Create .env
        run: |
          cat <<EOF > .env
          # API
          HTTP_CLIENT.BASE_URL=http://localhost:8080
          HTTP_CLIENT.TIMEOUT=10
          SWAGGER_COVERAGE_SERVICES=[{"key":"online_shop_test_api","name":"Online Shop Test API","repository":"https://github.com/Anychos/practice_api_test_server.git","swagger_url":"http://localhost:8080/openapi.json"}]
          ADMIN_DATA.EMAIL=test_admin@mail.ru
          ADMIN_DATA.PASSWORD=test_admin_password

          # UI
          BASE_URL=http://127.0.0.1:5000
          HEADLESS=false
          BROWSER=["chromium"]
          BROWSER_VIEWPORT={"width":1280,"height":720,"device_scale_factor":1}
          TEST_USER.EMAIL=test_user_1@example.com
          TEST_USER.NAME=Test User
          TEST_USER.PHONE=71234567890
          TEST_USER.PASSWORD=test_password_123
          TEST_USER.CONFIRM_PASSWORD=test_password_123
          SESSION_BROWSER_STATE_FILE=session-browser-state.json
          FUNCTION_BROWSER_STATE_FILE=function-browser-state.json
          ALLURE_RESULTS_DIR=./allure-results
          EOF

      - name: Run API tests
        run: |
          pytest tests/api \
                 --alluredir=allure-results-api \
                 -n auto \
                 --reruns 2 \
                 --reruns-delay 2

      - name: Upload API Allure results
        uses: actions/upload-artifact@v4
        with:
          name: allure-api
          path: allure-results-api

  # 3️⃣ UI тесты
  ui-tests:
    runs-on: ubuntu-latest
    needs: api-tests

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y curl

      - name: Install Python & Playwright dependencies
        run: |
          pip install -r requirements.txt
          playwright install --with-deps

      - name: Clone UI server
        run: git clone https://github.com/Anychos/practice_ui_test_server.git

      - name: Install & Run UI server
        run: |
          cd practice_ui_test_server
          pip install -r requirements.txt
          nohup python app.py > ui.log 2>&1 &

      - name: Wait for UI server
        run: |
          for i in {1..30}; do
            curl -s http://127.0.0.1:5000 && exit 0
            sleep 2
          done
          exit 1

      - name: Create .env
        run: |
          cat <<EOF > .env
          # API
          HTTP_CLIENT.BASE_URL=http://localhost:8080
          HTTP_CLIENT.TIMEOUT=10
          SWAGGER_COVERAGE_SERVICES=[{"key":"online_shop_test_api","name":"Online Shop Test API","repository":"https://github.com/Anychos/practice_api_test_server.git","swagger_url":"http://localhost:8080/openapi.json"}]
          ADMIN_DATA.EMAIL=test_admin@mail.ru
          ADMIN_DATA.PASSWORD=test_admin_password

          # UI
          BASE_URL=http://127.0.0.1:5000
          HEADLESS=false
          BROWSER=["chromium"]
          BROWSER_VIEWPORT={"width":1280,"height":720,"device_scale_factor":1}
          TEST_USER.EMAIL=test_user_1@example.com
          TEST_USER.NAME=Test User
          TEST_USER.PHONE=71234567890
          TEST_USER.PASSWORD=test_password_123
          TEST_USER.CONFIRM_PASSWORD=test_password_123
          SESSION_BROWSER_STATE_FILE=session-browser-state.json
          FUNCTION_BROWSER_STATE_FILE=function-browser-state.json
          ALLURE_RESULTS_DIR=./allure-results
          EOF

      - name: Run UI tests
        run: |
          pytest tests/ui \
                 --alluredir=allure-results-ui \
                 -n auto \
                 --reruns 2 \
                 --reruns-delay 3

      - name: Upload UI Allure results
        uses: actions/upload-artifact@v4
        with:
          name: allure-ui
          path: allure-results-ui

  # 4️⃣ Allure report
  allure-report:
    runs-on: ubuntu-latest
    needs: [api-tests, ui-tests]

    steps:
      - uses: actions/checkout@v4

      - name: Download API results
        uses: actions/download-artifact@v4
        with:
          name: allure-api
          path: allure-results

      - name: Download UI results
        uses: actions/download-artifact@v4
        with:
          name: allure-ui
          path: allure-results

      - name: Generate Allure report
        uses: simple-elf/allure-report-action@v1.7
        with:
          allure_results: allure-results
          allure_history: allure-history

      - name: Publish Allure report
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-history
          publish_branch: gh-pages


